<!DOCTYPE HTML>
<!--
	Strata by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Banking App</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />

        <!-- Bootstrap CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <!-- Custom CSS -->
        <link rel="stylesheet" href="style.css">

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="images/favicon.ico">
	</head>
	<body class="is-preload">

		<!-- Header -->
        <header id="header">
            <div class="display-balance">
                <div class="balance">
                    <h2>Balance</h2>
                    <p id="balance" class="totalBalance">$500</p>
                </div>
                <div class="expenses">
                    <h2>Expenses</h2>
                    <p id="expenses" class="totalExpenses">$200</p>
                </div>
            </div>
            <form class="expense-form">
                <div class="mb-3">
                  <input type="text" placeholder="Expense Description" class="form-control" id="expenseDescription" aria-describedby="emailHelp">
                </div>
                <div class="mb-3">
                  <input type="text" placeholder="Expense Amount" class="form-control" id="expenseAmount">
                </div>
                <div class="mb-3">
                    <select id="form-select" class="form-select" aria-label="Default select example">
                        <option selected>Select option</option>
                        <option value="deposit">Deposit</option>
                        <option value="withdraw">Withdraw</option>
                    </select>
                </div>
                <button type="submit" id="submitButton" class="btn btn-primary">Submit</button>
              </form>
        </header>

		<!-- Main -->
			<div id="main">
                <h2 class="display-5">Pending Transactions</h2>
                <p id="pendingText">
                  No Pending Transactions
                </p>
                <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">#</th>
                        <th scope="col">Amount</th>
                        <th scope="col">Transaction Type</th>
                        <th scope="col">Description</th>
                      </tr>
                    </thead>
                    <tbody id="pendingBody"></tbody>
                  </table>
                <h2 class="display-5">Approved Transactions</h2>
                <p id="approvedText">
                  No Approved Transactions
                </p>
                <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">#</th>
                        <th scope="col">Amount</th>
                        <th scope="col">Transaction Type</th>
                        <th scope="col">Description</th>
                        <th scope="col">Balance Post Transaction</th>
                        <th scope="col"></th>
                      </tr>
                    </thead>
                    <tbody id="approvedBody"></tbody>
                  </table>
			</div>
				
		<!-- Footer -->
			<footer id="footer">
				<div class="inner">
					<ul class="copyright">
						<li>&copy; Untitled</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.poptrox.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
            <!-- <tr>
                <th scope="row">1</th>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr> -->
            <script>
                console.log("Working");
                //Element creation format
                // let tableRow = document.createElement("tr");
                // tableRow.innerHTML = "4";
                // let tableHead = document.createElement("th");
                // tableHead.setAttribute("scope", "row")
                // let tableDataAmount = document.createElement("td");
                // let tableDataType = document.createElement("td");
                // let tableDataDescription = document.createElement("td");
                // let tableDataBalance = document.createElement("td");
                // tableRow.appendChild(tableHead);
                // tableRow.appendChild(tableDataAmount);
                // tableRow.appendChild(tableDataType);
                // tableRow.appendChild(tableDataDescription);
                // tableRow.appendChild(tableDataBalance);
                // document.getElementById("approvedBody").prepend(tableRow);
                
                initStorage();

                document.getElementById("submitButton").addEventListener("click", function(e){
                    e.preventDefault();
                    console.log("Button works");
                    document.getElementById("pendingText").innerHTML = "";

                    let formInfo = {
                        description: document.getElementById("expenseDescription").value,
                        amount: document.getElementById("expenseAmount").value,
                        type: document.getElementById("form-select").value,
                        balance: document.getElementById("balance").innerHTML
                    }
                    console.log(formInfo);

                    let tableRow = document.createElement("tr");
                    let tableHead = document.createElement("th");
                    tableHead.setAttribute("scope", "row")
                    let tableDataAmount = document.createElement("td");
                    tableDataAmount.innerHTML = formInfo.amount;
                    tableDataAmount.setAttribute("class", "amountPending")
                    let tableDataType = document.createElement("td");
                    tableDataType.innerHTML = formInfo.type;
                    tableDataType.setAttribute("class", "typePending")
                    let tableDataDescription = document.createElement("td");
                    tableDataDescription.innerHTML = formInfo.description;
                    tableDataDescription.setAttribute("class", "descPending");
                    tableRow.appendChild(tableHead);
                    tableRow.appendChild(tableDataAmount);
                    tableRow.appendChild(tableDataType);
                    tableRow.appendChild(tableDataDescription);
                    document.getElementById("pendingBody").prepend(tableRow);

                    console.log("before wait")
                    setTimeout(() => updatePending(), 3000);
                })
                
                //Local Storage
                function initStorage(){
                  let storageInfo = JSON.parse(localStorage.getItem("account")) || {
                    balance: 880,
                    approvedTransactions: [
                      {
                          "amount": 40,
                          "type": "withdraw",
                          "description": "Gas",
                          "post": 880
                      },
                      {
                        "amount": 500,
                        "type": "deposit",
                        "description": "Paycheck",
                        "post": 920
                      },
                      {
                        "amount": 80,
                        "type": "withdraw",
                        "description": "Electric Bill",
                        "post": 420
                      }
                    ],
                    pendingTransactions: [],
                    expenses: 120
                  };
                  console.log(storageInfo.balance);
                  console.log(storageInfo, "Account object in storage");
                  updateLocalStorage(storageInfo);
                  // Balance
                  let balanceElement = document.getElementById("balance");
                  balanceElement.innerHTML = `$${storageInfo.balance}`
                  // Expenses
                  let expensesElement = document.getElementById("expenses");
                  expensesElement.innerHTML = `$${storageInfo.expenses}`
                  //Prepopulate approved table
                  if(storageInfo.approvedTransactions){
                    console.log("posts exist")
                    document.getElementById("approvedText").innerHTML = "";
                  }
                  storageInfo.approvedTransactions.forEach(transaction => {
                    let tableRow = document.createElement("tr");
                    let tableHead = document.createElement("th");
                    tableHead.setAttribute("scope", "row")
                    let tableDataAmount = document.createElement("td");
                    tableDataAmount.innerHTML = `$${transaction.amount}`;
                    let tableDataType = document.createElement("td");
                    tableDataType.innerHTML = transaction.type;
                    let tableDataDescription = document.createElement("td");
                    tableDataDescription.innerHTML = transaction.description;
                    let tableDataBalance = document.createElement("td");
                    tableDataBalance.innerHTML = `$${transaction.post}`;
                    let tableCell = document.createElement("td");
                    let btn = document.createElement("button");
                    btn.setAttribute("class", "btn btn-danger");
                    btn.innerHTML = "Delete";
                    btn.addEventListener("click", function(){
                      //Removes table row from approved table
                      this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);
                      console.log(transaction);
                      let account = getLocalstorage();
                      for(let i = 0; i < account.approvedTransactions.length; i++){
                        if(account.approvedTransactions[i].description === transaction.description && account.approvedTransactions[i].amount === transaction.amount && account.approvedTransactions[i].type === transaction.type){
                          account.approvedTransactions.splice(i, 1);
                        }
                      }
                      //Reverse funds
                      if(transaction.type === "withdraw"){
                        account.balance += transaction.amount;
                        account.expenses -= transaction.amount;
                      }
                      else{
                        account.balance -= transaction.amount;
                      }
                      document.getElementById("balance").innerHTML = account.balance;
                      document.getElementById("expenses").innerHTML = account.expenses;
                      updateLocalStorage(account);
                    })
                    tableCell.appendChild(btn);
                    tableRow.appendChild(tableHead);
                    tableRow.appendChild(tableDataAmount);
                    tableRow.appendChild(tableDataType);
                    tableRow.appendChild(tableDataDescription);
                    tableRow.appendChild(tableDataBalance);
                    tableRow.appendChild(tableCell);
                    document.getElementById("approvedBody").appendChild(tableRow);
                  })
                }

                //Retrieve local storage object
                function getLocalstorage(){
                  return JSON.parse(localStorage.getItem("account"));
                }
                //Updates local storage object, takes in object
                function updateLocalStorage(storageInfo){
                    localStorage.setItem("account", JSON.stringify(storageInfo));
                    console.log("Local storage updated");
                }

                //Moves pending to approved table
                function updatePending(){
                    let account = getLocalstorage();
                    console.log(account);
                    let amounts = document.getElementsByClassName("amountPending");
                    let types = document.getElementsByClassName("typePending");
                    let description = document.getElementsByClassName("descPending");
                    let pendingArray = [];
                    for(let i = 0; i < amounts.length; i++){
                        // console.log(amounts[i].innerHTML + " " + types[i].innerHTML);
                        pendingArray.unshift({
                          amount: parseInt(amounts[i].innerHTML),
                          type: types[i].innerHTML,
                          description: description[i].innerHTML
                        })
                    }
                    console.log(pendingArray);
                    pendingArray.forEach( transaction => {
                      console.log(transaction);
                      //Calculate post balance
                      if(transaction.type == "withdraw"){
                        account.balance -= transaction.amount;
                        account.expenses += transaction.amount;
                      }
                      else {
                        account.balance += transaction.amount;
                      }
                      //Create post balance transaction
                      console.log(account);
                      transaction.post = account.balance;
                      //Prepend transaction to account
                      console.log(transaction);
                      account.approvedTransactions.unshift(transaction);

                      //Update balance & expenses
                      // Balance
                      let balanceElement = document.getElementById("balance");
                      balanceElement.innerHTML = `$${account.balance}`
                      // Expenses
                      let expensesElement = document.getElementById("expenses");
                      expensesElement.innerHTML = `$${account.expenses}`
                      //Add new row to approved and delete table row in pending
                      let tableRow = document.createElement("tr");
                      let tableHead = document.createElement("th");
                      tableHead.setAttribute("scope", "row")
                      let tableDataAmount = document.createElement("td");
                      tableDataAmount.innerHTML = `$${transaction.amount}`;
                      let tableDataType = document.createElement("td");
                      tableDataType.innerHTML = transaction.type;
                      let tableDataDescription = document.createElement("td");
                      tableDataDescription.innerHTML = transaction.description;
                      let tableDataBalance = document.createElement("td");
                      tableDataBalance.innerHTML = `$${account.balance}`;
                      let tableCell = document.createElement("td");
                      let btn = document.createElement("button");
                      btn.innerHTML = "Delete";
                      btn.setAttribute("class", "btn btn-danger");
                      btn.addEventListener("click", function(){
                        //Removes table row from approved table
                      this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);
                      console.log(transaction);
                      let account = getLocalstorage();
                      for(let i = 0; i < account.approvedTransactions.length; i++){
                        if(account.approvedTransactions[i].description === transaction.description && account.approvedTransactions[i].amount === transaction.amount && account.approvedTransactions[i].type === transaction.type){
                          account.approvedTransactions.splice(i, 1);
                        }
                      }
                      //Reverse funds
                      if(transaction.type === "withdraw"){
                        account.balance += transaction.amount;
                        account.expenses -= transaction.amount;
                      }
                      else{
                        account.balance -= transaction.amount;
                      }
                      document.getElementById("balance").innerHTML = `$${account.balance}`;
                      document.getElementById("expenses").innerHTML = `$${account.expenses}`;
                      updateLocalStorage(account);
                      })
                      tableCell.appendChild(btn);
                      tableRow.appendChild(tableHead);
                      tableRow.appendChild(tableDataAmount);
                      tableRow.appendChild(tableDataType);
                      tableRow.appendChild(tableDataDescription);
                      tableRow.appendChild(tableDataBalance);
                      tableRow.appendChild(tableCell);
                      document.getElementById("approvedBody").prepend(tableRow);
                      let parent = document.getElementById("pendingBody");
                      console.log(parent);
                      console.log(parent.lastChild);
                      parent.removeChild(parent.lastChild);
                      //Add text to pending table
                      document.getElementById("pendingText").innerHTML = "No Pending Transactions"
                    })
                    console.log(account);

                    //Update Local Storage
                    updateLocalStorage(account);

                    
                }
            </script>
	</body>
</html>